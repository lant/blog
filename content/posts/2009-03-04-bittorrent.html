---
layout: post
title: Bittorrent
date: '2009-03-04T21:22:00.017Z'
author: Marc de Palol
tags:
- bittorrent
- protocols
modified_time: '2009-03-15T12:40:58.015Z'
thumbnail: http://2.bp.blogspot.com/_a84GcWW6wwE/SbhO6eo-9rI/AAAAAAAAAOQ/QobcFY1acCU/s72-c/Picture+3.png
blogger_id: tag:blogger.com,1999:blog-6541464271719475452.post-6853724565233395525
blogger_orig_url: http://distribuint.blogspot.com/2009/03/bittorrent.html
---

<div style="text-align: justify;">Començo el nou blog amb un post sobre protocols, avui Bittorrent!</div><div style="text-align: justify;"><br /></div><div style="text-align: justify;">Suposo que tothom, més o menys coneix el Bittorrent, aquest "<i>programa per descarregar pel·lícules"</i>. Doncs bé, <b>bittorrent</b> és el nom del protocol, també de l'empresa que el va fer i d'un programa que utilitza aquest protocol. Sí, realment poca imaginació. </div><div style="text-align: justify;"><br /></div><div style="text-align: justify;">Bàsicament és un protocol per distribuir fitxers, fa temps s'usa de forma popular, però últimament ha tingut bastant resó mediàtic pel judici que ha tingut lloc a Suècia contra la pàgina d'emmagatzemament de .<i>torrents</i>  <a href="http://thepiratebay.org/">The Pirate Bay</a>. Al final sembla ser que poca cosa han pogut fer perquè tal pàgina tant sols guardava els fitxers .<span style="font-style: italic;">torrent</span> i només actuava de <span style="font-style: italic;">tracker</span>, i això no és delicte oi ?, ara probablement algú es preguntarà  què és un .<span style="font-style: italic;">torrent</span>? què és un <span style="font-style: italic;">tracker</span> ? ara anem a això!</div><div style="text-align: justify;"><br /><span style="font-size:180%;">Protocol</span></div><div style="text-align: justify;"><br /></div><div style="text-align: justify;">El gran avantate que té el bittorrent sobre l'HTTP clàssic és que quan hi ha diverses baixades del mateix fitxer de forma concurrent (diverses persones volen baixar-se el mateix fitxer alhora), aquests usuaris s'envien trossos del fitxer entre ells. Per tant, com més persones hi hagi baixant un fitxer millor.</div><div style="text-align: justify;"><br /></div><div style="text-align: justify;"><span style="font-size:130%;">Com funciona.</span></div><div style="text-align: justify;"><span class="Apple-style-span"  style="font-size:180%;"><span class="Apple-style-span"  style="font-size:18px;"><br /></span></span></div><div style="text-align: justify;">El funcionament de cara l'usuari és ben senzill. </div><div style="text-align: justify;"><br /></div><div style="text-align: justify;"><img style="display:block; margin:0px auto 10px; text-align:center;cursor:pointer; cursor:hand;width: 320px; height: 222px;" src="http://2.bp.blogspot.com/_a84GcWW6wwE/SbhO6eo-9rI/AAAAAAAAAOQ/QobcFY1acCU/s320/Picture+3.png" border="0" alt="" id="BLOGGER_PHOTO_ID_5312082527047841458" /></div><div style="text-align: justify;"><br /></div><div style="text-align: justify;">Un usuari es baixa un fitxer amb extensió .<span style="font-style: italic;">torrent</span>, és un fitxer petit, menys de 60ks. Tot seguit s'obre amb el <a href="http://en.wikipedia.org/wiki/List_of_BitTorrent_clients">client de bittorrent</a> i el fitxer es comença a descarregar. Pim pam.</div><div style="text-align: justify;"><br /></div><div style="text-align: justify;">En resum i explicat d'una forma planera el que passa és el següent:</div><div style="text-align: justify;"><br />Quan l'usuari obre el fitxer .<span style="font-style: italic;">torrent</span> amb el seu client, aquest contacta amb el <span style="font-style: italic;">tracker</span> (la direcció del <span style="font-style: italic;">tracker</span> està dins el fitxer .<span style="font-style: italic;">torrent</span>) que és un programa instal·lat en un servidor d'internet, i s'identifica com un usuari que es vol baixar aquell fitxer en concret. Tot seguit el <span style="font-style: italic;">tracker <span class="Apple-style-span" style="font-style: normal; ">contesta amb les IP's dels diferents <span style="font-style: italic;">peers</span> (altres usuaris) que s'estan baixant el fitxer, i que per tant, en ténen trossos. Seguidament el client contacta  amb aquesta llista d'usuaris i els hi comença a demanar trossos, més endavant aquest client també compartirà els trossos que ja té. </span></span></div><div style="text-align: justify;"><br /></div><div style="text-align: justify;"><span style="font-style: italic;"><span class="Apple-style-span" style="font-style: normal; ">De tant en tant contactaran amb el <span style="font-style: italic;">tracker</span> de nou per refrescar la llista d'usuaris connectats que comparteixen aquest fitxer.</span></span></div><div style="text-align: justify;"><br /><span style="font-size:130%;">Fitxer Torrent</span><br /><br />El fitxer .<span style="font-style: italic;">torrent</span> és un fitxer binari. Bàsicament és un diccionari amb els següents camps i valors:<span style="font-family:courier new;"></span></div><div style="text-align: justify;"><ul><li><span style="font-family:courier new;">announce</span>: La URL del <span style="font-style: italic;">tracker</span>.</li> <li><span style="font-family:courier new;">info</span>: És un altre diccionari que conté:<br /></li> <ul><li> <span style="font-family:courier new;">name</span>: Nom suggerit per guardar el fitxer o el directori.<br /></li><li><span style="font-family:courier new;">pieces length</span>: Mida dels trossos en que es parteix el fitxer (o fitxers) en bytes. El protocol parteix el fitxer en trossos del mateix tamany, amb la única possible excepció de l'últim tros. Els trossos normalment són de 256Ks tot i que es veu que en versions del protocol anteriors els trossos eren de 1Mb.<br /></li><li><span style="font-family:courier new;">pieces</span>: És un string, la mida del qual és múltiple de 20. Cada 20 caràcters representa el hashing <a href="http://www.faqs.org/rfcs/rfc3174.html">SHA1</a> del tros que representa, per tant hi haurà tants subtrossos de 20 com trossos tingui el fitxer, i a cada posició 20*i , sient 0 <= i < #trossos hi ha el hashing per a aquell tros en concret. </li><li><span style="font-family:courier new;">length/files</span>: O bé hi ha <span style="font-style: italic;">length</span> o bé hi ha<span style="font-style: italic;"> files</span>, però estrictament un (i només un) dels dos. En cas de que sigui <span style="font-style: italic;">length</span>, significa que el que s'està baixant és un sol fitxer i en <span style="font-style: italic;">length</span> és el tamany total d'aquest en bytes. En cas de que sigui <span style="font-style: italic;">files</span> representa un conjunt de fitxers dins d'una estructura de directori.<br /></li></ul><ul><li><span style="font-family:courier new;">path:</span> Una llista d'strings que corresponen a noms de subdirectoris, en cas de que existeixin.<br /></li></ul></ul><img style="display:block; margin:0px auto 10px; text-align:center;cursor:pointer; cursor:hand;width: 320px; height: 91px;" src="http://3.bp.blogspot.com/_a84GcWW6wwE/SbhO6yrB-RI/AAAAAAAAAOY/XFw36ZQkjDE/s320/Picture+4.png" border="0" alt="" id="BLOGGER_PHOTO_ID_5312082532425136402" /><br /><br /><span style="font-size:130%;">Tracker</span><br /><br />El <span style="font-style: italic;">tracker</span> és el software que comunica els usuaris amb altres usuaris, hi ha diverses implementacions, una de les més famoses és <a href="http://opentracker.blog.h3q.com/">opentrack</a><a href="http://opentracker.blog.h3q.com/">er</a>, que és la que utilitzen entre d'altres <span style="font-weight: bold;">The Pirate Bay</span> i la <span style="font-weight: bold;">Wikipedia</span>. A destacar la seva llicència, <a href="http://en.wikipedia.org/wiki/Beerware">beerware</a>.</div><div style="text-align: justify;"><br /></div><div style="text-align: justify;">Quan un client fa un <span style="font-style: italic;">GET</span> (demana informació) a un tracker, la comanda <span style="font-style: italic;">HTTP</span> té els següents valors:<br /><ul><li> <span style="font-family:courier new;">info_hash</span>: És un string de 20 bytes amb el hash SHA1 de l'apartat info del fitxer de metainfomració (aka .<span style="font-style: italic;">torrent</span>)<br /></li><li> <span style="font-family:courier new;">peer_id</span>: Id de l'usuari que es vol baixar el fitxer, aquest id és totalment aleatori i és generat pel client cada vegada que comença a baixar-se un fitxer de nou.<br /></li><li> <span style="font-family:courier new;">ip</span>: (Paràmetre opcional) IP del client.<br /></li><li> <span style="font-family:courier new;">port</span>: És el port al qual escolta el client, normalment és el 6881, en cas de que estigui ocupat és el 6882 i anar pujant fins al 6889.<br /></li><li> <span style="font-family:courier new;">uploaded</span>: Els bytes que s'han pujat d'aquest fitxer. Això són els bytes que aquest client en particular ha enviat a altres peers.<br /></li><li> <span style="font-family:courier new;">downloaded</span>: Bytes que s'han baixat fins aquest moment.<br /></li><li> <span style="font-family:courier new;">left</span>: Número de bytes que falten per completar la transferència del fitxer. Cal notar que no té perquè ser el mateix que el resultat de la mida del fitxer - downloaded, ja que pot ser que hi hagi hagut una corrupció de dades o problemes de transferència, i que per tant algun tros de fitxer s'hagi de tornar a baixar.<br /></li><li> <span style="font-family:courier new;">event</span>: És l'estat del client, pot ser started, quan s'està començant a baixar des del començament, completed un cop té tot el fitxer o <span style="font-style: italic;">stopped</span>, un cop es para de baixar.</li></ul><br />La resposta del tracker al client també són diccionaris en binari. Pot ser que el tracker contesti amb una entrada de <i>failure</i>, amb un contingut que és un string llegible amb el missatge d'error.  En cas de que tot hagi anat bé el diccionari conté dues claus, la primera <i>interval</i>, que són el número de segons en que el client hauria de tornar a fer una petició d'informació al <i>tracker</i>. La següent entrada serà <i>peers</i>, que conté una llista de id's, ips i ports dels <i>peers</i> que s'estan baixant el fitxer.  En cas de que hi hagi algun aconteixement especial un client pot fer una requesta d'informació al <i>tracker</i> encara que no hagi passat el temps indicat per aquest.</div><div style="text-align: justify;"><br /><span style="font-size:130%;">Comunicació entre peers</span><br /><br />La comunicació entre <i>peers</i> és simètrica. Els missatges que s'envien d'un <i>peer</i> a l'altre són del mateix format i les dades (del fitxer que s'està compartint) poden anar també en els dos sentits.</div><div style="text-align: justify;"><br />Els <i>peers</i> es refereixen als diferents trossos del fitxer compartit amb indexs, que són exactament els mateixos indexs que hi ha al fitxer de metainformació. Un cop un client s'ha baixat un tros del fitxer i n'ha comprovat l'integritat amb el mapa SHA1 ho comunica a la resta de peers.<br /><br /></div><div style="text-align: justify;">Les connexions entre <i>peer</i> i <i>peer</i> contenen dos bits d'estat. El primer, <i>choked</i> (tapat), si o no, i el segon, <i>interessat</i>, si o no. El bit the <i>choked</i> indica que el client està tapat, això vol dir que no enviarà més informació fins que sigui "destapat".<br /><br />Una transferència de dades entre dos <i>peers</i> té lloc quan un dels dos està interessat i l'altre no està tapat. En cas de que un client no estigui interessat en res que tingui un altre client (sempre que aquest últim estigui destapat) aquest ho ha de fer constar amb el bit de interessat a fals.<br /><br />El protocol recomana que quan s'està enviant dades, els clients haurien de tenir encuades a memòria diverses peticions de trossos per tenir una bona rendiment TCP, per altra banda quan s'està enviant dades a un altre peer també haurien de tenir els trossos a enviar a memòria, i en cas de que s'anul·li per qualsevol motiu la transferència, probablement el client quedi tapat. aquests trossos es poden borrar fàcilment. Això com ja he dit són recomanacions del protocol, caldria mirar exactament com s'implementa en cada client.</div><div style="text-align: justify;"><br /></div><div style="text-align: justify;">Per tant, quan dos clients s'envien missatges tenim bàsicament que comencen amb un handshake seguit per un fluxe d'informació de mida prefixada.<br /><br />El handshake comença amb el número 19 en decimal seguit de l'string '<span class="Apple-style-span"  style="font-family:'courier new';">BitTorrent protocol</span>'. A partir d'aquí, tots els números seran enters codficats en 4 bytes en <i>big</i>-<i>endian</i>. Seguidament venen els 20 bytes de hash SHA1 de la taula info_value del fitxer de metainformació, en cas de que els dos clients no donguin exactament el mateix hash, es talla la comunicació entre ells. En cas de que tot vagi bé s'envien 20 bytes més amb l'identificació del clients, en cas de que aquesta informació (l'id del client amb qui s'està comunicant) no aparegui a la informació sobre clients que havia donat el tracker, es talla la comunicació.</div><div style="text-align: justify;"><br />Tot seguit tenim el que és la comunicació en si entre peers, els missatges amb mida de cos cero són pings per fer saber i mantenir l'estat dels peers i s'envien cada dos minuts. En cas de que el cos del missatge tingui més d'un byte llavors cal mirar quin tipus de missatge es tracte:<span class="Apple-style-span"  style=" ;font-family:'courier new';"></span></div><div style="text-align: justify;"><ul><li><span class="Apple-style-span"  style=" ;font-family:'courier new';">0 - Choke</span></li><li  style="font-family:courier new;"><span class="Apple-style-span"  style="font-family:'courier new';">1 - Unchoke</span></li><li face="courier new">2 - Interested</li><li face="courier new">3 - Not Interested</li><li><span style="font-family:courier new;">4 - Have</span>: És un número que indica que s'ha acabat de transferir i comprovat la integritat d'un nou tros.<br /></li><li><span style="font-family:courier new;">5 - Bitfield:</span> És un mapa de bits on cadascun indica quins trossos de fitxer s'ha enviat.</li><li><span style="font-family:courier new;">6 - request</span>: Bàsicament és una petició perquè li enviin un tros. De paràmetre té un index.<br /></li><li><span style="font-family:courier new;">7 - piece: </span>Les dades en si del fitxer.<br /></li><li style="font-family: courier new;">8 - cancel:<span style="font-family:georgia;"> Demana per cancel·lar una transmissió. </span><br /></li></ul>A l'hora de baixar els trossos normalment els clients trien els trossos de forma aleatori, així s'aconsegueix que estranyament es donguin situacions d'inanició que són les quals en que hi ha alguns trossos del fitxer que només estiguin en un o poc clients, cosa que faria que en el cas que aquests paressin de pujar fitxers ningú podria tenir el fitxer complert. Això forma part del protocol oficial de Bittorrent, tot i que algunes implementacions intenten millorar aquest aspecte fent que els trossos menys continguts en global entre els clients siguin els que tenen més prioritat per ser enviats.</div><div style="text-align: justify;"><br /></div><div style="text-align: justify;"><img style="display:block; margin:0px auto 10px; text-align:center;cursor:pointer; cursor:hand;width: 320px; height: 95px;" src="http://4.bp.blogspot.com/_a84GcWW6wwE/SbhO6Q78aKI/AAAAAAAAAOI/1c8cD9Jro5M/s320/Picture+2.png" border="0" alt="" id="BLOGGER_PHOTO_ID_5312082523369269410" /><span style="font-size:180%;"><div style="text-align: left;"><span class="Apple-style-span"  style="font-size:small;">i bàsicament... és això :)</span></div><div style="text-align: left;"><br /></div><div style="text-align: left;">Jerga</div><div style="text-align: left;"><br /></div></span></div><div style="text-align: justify;">Vinga va, una mica de paraulotes relacionades amb el tema:<br /><ul><li><span style="font-family:courier new;">p2p</span>: Peer 2 Peer, d'un a l'altre, d'un punt a l'altre, d'una persona a una altre, bla bla bla<br /></li><li><span style="font-family:courier new;">peer</span>: Un punt (ordinador, màquina, persona...) que participa en una comunicació P2P<br /></li><li><span style="font-family:courier new;">seed</span>: En el món bittorrent seeder és una persona que permet que d'altres puguin obtenir el fitxer un cop ell/a ja el té. Per tant, que no borra el fitxer una vegada l'ha baixat, sinó que el continua compartint.<br /></li><li><span style="font-family:courier new;">leecher</span>: justament al revés que el seeder, una persona que no comparteix el fitxer, tant sols el baixa.<br /></li></ul><span style="font-size:180%;">Links</span><br /><ul><li><a href="http://www.bittorrent.org/beps/bep_0003.html">Especificació del protocol</a>. Bastant ben explicat i bastant planera. </li><li><a href="http://ca.wikipedia.org/wiki/BitTorrent">Wikipedia</a> Hi ha un gràfic molt interessant. Pago una cervesa a qui l'entengui!<br /></li></ul></div><div style="text-align: center;"><br /></div><div style="text-align: center;"><br /></div>